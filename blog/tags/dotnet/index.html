<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">One post tagged with &quot;dotnet&quot; | Conner Phillis&#x27;s blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://connerphillis.github.io/website/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://connerphillis.github.io/website/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://connerphillis.github.io/website/blog/tags/dotnet"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="One post tagged with &quot;dotnet&quot; | Conner Phillis&#x27;s blog"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/website/favicon.ico"><link data-rh="true" rel="canonical" href="https://connerphillis.github.io/website/blog/tags/dotnet"><link data-rh="true" rel="alternate" href="https://connerphillis.github.io/website/blog/tags/dotnet" hreflang="en"><link data-rh="true" rel="alternate" href="https://connerphillis.github.io/website/blog/tags/dotnet" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/website/blog/rss.xml" title="Conner Phillis&#39;s blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/website/blog/atom.xml" title="Conner Phillis&#39;s blog Atom Feed"><link rel="stylesheet" href="/website/assets/css/styles.cb5e6b95.css">
<link rel="preload" href="/website/assets/js/runtime~main.ed462fe7.js" as="script">
<link rel="preload" href="/website/assets/js/main.329b349d.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/website/"><div class="navbar__logo"><img src="/website/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/website/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">My Site</b></a><a class="navbar__item navbar__link" href="/website/docs/intro">Tutorial</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/website/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/website/blog/Sequential GUIDs in EF Core Might Not Be Sequential">Sequential GUIDs in EF Core Might Not Be Sequential</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/website/blog/welcome">Welcome</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/website/blog/mdx-blog-post">MDX Blog Post</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/website/blog/long-blog-post">Long Blog Post</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/website/blog/first-blog-post">First Blog Post</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>One post tagged with &quot;dotnet&quot;</h1><a href="/website/blog/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/website/blog/Sequential GUIDs in EF Core Might Not Be Sequential">Sequential GUIDs in EF Core Might Not Be Sequential</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-02-27T00:00:00.000Z" itemprop="datePublished">February 27, 2023</time> · <!-- -->12 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/connerphillis" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/connerphillis.png" alt="Conner Phillis"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/connerphillis" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Conner Phillis</span></a></div><small class="avatar__subtitle" itemprop="description">Lead Developer, Keymark Labs</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-background">The Background<a href="#the-background" class="hash-link" aria-label="Direct link to The Background" title="Direct link to The Background">​</a></h3><p>Our customers more often than not chose to host our application on their own machines, so we frequently get asked what the minimum hardware requirements are. We base the estimates we provide on the requirements of similar applications, but we had never put in the work to really test our application and see what sort of throughput we could expect.</p><p>We decided to finally get a conclusive answer for ourselves, so we would put some resources into running benchmarks. We settled on a simple setup. Write a simple script that would simulate a series of requests that would run through hot paths, and see how many operations we could complete in a fixed time frame. The script would run X number of concurrent requests for N minutes, log the statistics to a CSV file and export our results to a CSV file for analysis.</p><p>We architected our test server to simulate an organization stressed for resources. On a single virtual machine we installed SQL Server, IIS, and our application. For the hardware behind the virtual machine we used an Azure F4s v2 (4 vCPU, 8GB).</p><p>For our warm up, we ran the script with 20 concurrent tasks for 10 minutes, the results that we got?</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">263724 total requests completed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">67431 form submissions in 10 minutes across 20 tasks</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>While this may not seem like a lot for some, this was great for us. We consider our workloads somewhat computationally expensive, and didn&#x27;t imagine we would get these sort of numbers out of our code. Especially when hosting the server and database on the same machine.</p><p>Our logs indicated that we were on average consuming about 70% of the CPU. The data that we got was plenty for us to determine our hardware requirements, but just for fun we decided to see how far we could push it. We resized the VM to an F8s V2 (8 vCPU 16GB) expecting linear results.</p><p>The script was set, 50 concurrent tasks instead of 20 to account for the increase in core count,running for ten minutes. The results?</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">275532 total requests completed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">68883 form submissions in 10 minute across 50 tasks.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong><em>What!?!?</em></strong> We doubled the hardware, 2.5x&#x27;d the number of concurrent runs, and ended up with only ~3% more completed requests. This set off an alarm for us, we obviously had a large issue with the scalability of our application.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="investigating-the-issue">Investigating the Issue<a href="#investigating-the-issue" class="hash-link" aria-label="Direct link to Investigating the Issue" title="Direct link to Investigating the Issue">​</a></h3><p>The first thing that we theorized was that the increased number of tasks was causing problems with IIS, causing connections to stay open for longer than they should. We altered our the parameters of our test script to use 20 tasks over 10 minutes, mirroring the test against the F4s machine. After 10 minutes, the results were...</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">275916 total requests completed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">68979 form submissions in 10 minutes across 10 tasks</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong><em>The same??</em></strong> There was only a marginal difference in the results. Less than 1% from the original run. The test machine was hardly using a fraction of the processing power and network it could utilize. Something bigger was afoot.</p><p>We started a Remote Desktop session with the server and ran another test, 10 minutes, 20 cores. We observed SQL Server start by consuming ~30% of our CPU time, and watched it move up to as much as 60% of the CPU by the end of the run. Over time, our performance was getting <em>worse</em>.</p><p>On a whim, we ran a query to check for index fragmentation of the database.</p><p><img loading="lazy" alt="Production Index Fragmentation" src="/website/assets/images/Production-Index-Fragmentation-5f1c68d7b573a229d9debbc873c2acff.png" width="842" height="805" class="img_ev3q"></p><p>The index fragmentation was far above what could be expected out of a healthy database. North of 50% for some indexes. While we can&#x27;t <em>prove</em> right now that this is what is causing our scaling issue<sup><a href="#footnote1">1</a></sup> it does explain how SQL server can continuously need more resources. As the size of the data grows, SQL is having to spend more time doing table scans and expending more resources on IO.</p><p>We found this puzzling, we were using Entity Framework Core&#x27;s <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.entityframeworkcore.valuegeneration.sequentialguidvaluegenerator?view=efcore-7.0" target="_blank" rel="noopener noreferrer"><code>Sequential Guid Value Generator</code></a> With the <a href="https://learn.microsoft.com/en-us/dotnet/api/system.componentmodel.dataannotations.schema.databasegeneratedoption?view=net-7.0" target="_blank" rel="noopener noreferrer"><code>DatabaseGeneratedOption.Identity</code></a> option. The documentation states:</p><blockquote><p>Generates sequential Guid values optimized for use in Microsoft SQL server clustered keys or indexes, yielding better performance than random values. This is the default generator for SQL Server Guid columns which are set to be generated on add.</p></blockquote><p>It&#x27;s important to note in addition to this documentation for those that aren&#x27;t aware, setting a column to use a GUID as a key with <code>DatabaseGeneratedOption.Identity</code> <strong>does not mean that it will be generated by the database</strong>. Instead, EF Core generates the sequential GUID itself, and then inserts it into the database (<a href="https://weblogs.asp.net/ricardoperes/current-limitations-of-entity-framework-core#:~:text=For%20GUIDs%2C%20EF%20Core%20automatically%20generates%2C%20on%20the,makes%20it%20database-specific%20%E2%80%93%20currently%2C%20SQL%20Server%20only." target="_blank" rel="noopener noreferrer">read here</a>). This can be observed when comparing GUIDs generated normally to those generated by <code>NEWSEQUENTIALID</code> later in this post.</p><p>Additionally, <a href="https://github.com/dotnet/efcore/pull/20528#issuecomment-612889464" target="_blank" rel="noopener noreferrer">this issue</a> in the EF core repository shows that EF core generates GUIDs <em>better</em> than SQL Server does. The documentation wasn&#x27;t lining up with what we were seeing, it was time to recreate the EF tests, and see if we could simulate the behavior we were getting from our server.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="running-our-own-benchmarks">Running our Own Benchmarks<a href="#running-our-own-benchmarks" class="hash-link" aria-label="Direct link to Running our Own Benchmarks" title="Direct link to Running our Own Benchmarks">​</a></h3><p>The first thing we did was see if we could reproduce the test done by <a href="https://github.com/roji" target="_blank" rel="noopener noreferrer">roji</a> on the EF core team with 100000. And...</p><table><thead><tr><th>Method</th><th align="right">Average page space used in %</th><th align="right">Average fragmentation in percent</th><th align="right">Record Count</th></tr></thead><tbody><tr><td>NEWSEQUENTIALID</td><td align="right">99.91 %</td><td align="right">1.04 %</td><td align="right">100000</td></tr><tr><td>EF Core Sequential Guid Value Generator</td><td align="right">99.86 %</td><td align="right">0.56 %</td><td align="right">100000</td></tr></tbody></table><p>Same results as the team found. The EF Core value generator is still generating GUIDs optimally as of SQL Server 2022.</p><p>But wait... this isn&#x27;t really how a web server works. Entities aren&#x27;t just inserted one after another when coming from a web server. Entries are created in response to user activity, and that can happen whenever. Database activity happens spontaneously, whenever a user performs an action, and different user hardware can mean these operations can take different amounts of time. What if we modify the test, instead to simulate a large degree of parallel actions rather than pure sequential inserts? </p><p>We altered our script, instead of inserting 100,000 sequential ids into the database, we created 20 tasks, and told each of those tasks to insert 5000 rows into the database. Once this was done we looked at index fragmentation again.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="parallel-entity-framework-sequential-guid-generation">Parallel Entity Framework Sequential Guid Generation<a href="#parallel-entity-framework-sequential-guid-generation" class="hash-link" aria-label="Direct link to Parallel Entity Framework Sequential Guid Generation" title="Direct link to Parallel Entity Framework Sequential Guid Generation">​</a></h5><table><thead><tr><th align="right">average page space used in %</th><th align="right">average fragmentation in percent</th><th align="right">Record Count</th></tr></thead><tbody><tr><td align="right">57.93 %</td><td align="right">44.53 %</td><td align="right">100000</td></tr></tbody></table><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Multithreaded Simulation Code</summary><div><div class="collapsibleContent_i85q"><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class Program</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  static async Task Main(string[] args)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    await using var globalCtx = new BlogContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    await globalCtx.Database.EnsureDeletedAsync();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    await globalCtx.Database.EnsureCreatedAsync();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    await globalCtx.DisposeAsync();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var counter = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var tasks = new List&lt;Task&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 0; i &lt; 20; i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      var t = Task.Run(async () =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await using var ctx = new BlogContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (var j = 0; j &lt; 5000; j++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          var value = Interlocked.Increment(ref counter);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ctx.Blogs.Add(new Blog { Name = &quot;Foo&quot; + value });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          await ctx.SaveChangesAsync();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tasks.Add(t);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    await Task.WhenAll(tasks);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class BlogContext : DbContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public DbSet&lt;Blog&gt; Blogs { get; set; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    =&gt; optionsBuilder.UseSqlServer(&quot;Server=.;Database=Testing;Trusted_Connection=true;Encrypt=false;&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Blog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public Guid Id { get; set; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public string Name { get; set; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><p>The top 10 results returned when querying the database illuminate the issue: <img loading="lazy" alt="TOP 10 Results From SequentialGuidValueGenerator" src="/website/assets/images/Sequential-Guid-Value-Generator-Order-32d06dc998d21088408b56c6be685765.png" width="508" height="392" class="img_ev3q"></p><p>Our conclusion? <strong>Entity Framework seeks to create an efficient value generation strategy optimized for SQL Server, but after the network stack has its say, its likely that some rows will be inserted out of their original order.</strong></p><p>Compare that to the results that you get when running the same code, but setting <code>HasDefaultValueSql(&quot;NEWSEQUENTIALID()&quot;)</code> in the <code>OnModelCreating</code> method in the database context:</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="parallel-guid-generation-with-newsequentialid">Parallel Guid Generation with NEWSEQUENTIALID()<a href="#parallel-guid-generation-with-newsequentialid" class="hash-link" aria-label="Direct link to Parallel Guid Generation with NEWSEQUENTIALID()" title="Direct link to Parallel Guid Generation with NEWSEQUENTIALID()">​</a></h5><table><thead><tr><th align="right">average page space used in %</th><th align="right">average fragmentation in percent</th><th align="right">Record Count</th></tr></thead><tbody><tr><td align="right">96.03 %</td><td align="right">7.67 %</td><td align="right">100000</td></tr></tbody></table><p>The fragmentation percentage is still not as good as inserting the rows one after the other, and the average page space used is a bit lower, but I think we can all agree that it&#x27;s better than generating the IDs in memory with Entity Framework Core.</p><p>This method has drawbacks too, however. Looking at the GUIDs that SQL generates it&#x27;s hard to say that they have the same uniqueness guarantee that standard GUIDs have. It appears that the leading bits of the GUIDs are all that change when taking a sample of the first 10 inserted in the database after our concurrent test:</p><p><img loading="lazy" alt="NEWSEQUENTIALID Results" src="/website/assets/images/sql-sequential-guids-323ab8b5a894a9b5a74cfac28cecd10c.png" width="608" height="403" class="img_ev3q"></p><p>(in case anyone is curious, generating the GUIDs randomly led to a fragmentation percentage of almost 99%)</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="studying-the-issue">Studying the Issue<a href="#studying-the-issue" class="hash-link" aria-label="Direct link to Studying the Issue" title="Direct link to Studying the Issue">​</a></h3><p>There were two main benefits that initially brought us to use GUIDs as primary keys in our database.</p><ol><li>We sometimes have to export data across servers, so the (near) uniqueness guarantee meant that it should be trivial to merge the data</li><li>Certain actions don&#x27;t require our users to be connected to our server all the time as long as they do a periodic sync. In this case we could let the client generate IDs and after the sync turn the IDs into sequential ones. Once we were done with the transformation we just had to inform the client of the new IDs.</li></ol><p>Unfortunately, the SQL server GUIDs don&#x27;t seem like they would be able to cut it for us, as it seems likely that a collision could occur when exporting from one server to another.</p><p>This led us to a tough crossroad. Do we</p><ol><li>Keep going, knowing that scaling up our application leads to highly diminishing returns necessitating expensive hardware OR</li><li>Lose the benefits GUIDs give us in favor of another primary key format that would be better suited for parallel inserts.</li></ol><p>Ultimately, we decided that our best path forward was to go with a hybrid approach. We would alter our tables to have two IDs where GUIDs are required. This involved using an integer primary key generated by the database, and GUID value as a non-clustered index with a unique constraint. These GUIDs would use the <code>SequentialGuidValueGenerator</code> to try to &quot;presort&quot; some of the items in the non-clustered index, but we wouldn&#x27;t enforce that it had to be a sequential GUID.</p><p>After performing our parallel benchmark, we ended up with the following results:</p><h6 class="anchor anchorWithStickyNavbar_LWe7" id="hybrid-key-generation-approach">Hybrid Key Generation Approach<a href="#hybrid-key-generation-approach" class="hash-link" aria-label="Direct link to Hybrid Key Generation Approach" title="Direct link to Hybrid Key Generation Approach">​</a></h6><table><thead><tr><th align="right">average page space used in %</th><th align="right">average fragmentation in percent</th><th align="right">Record Count</th></tr></thead><tbody><tr><td align="right">94.15 %</td><td align="right">10.38 %</td><td align="right">100000</td></tr></tbody></table><p>Just in case we ran the benchmark again with only an integer primary key, that yielded a fragmentation percentage of almost exactly 12%. It really just seems that some fragmentation is unavoidable in a parallel context.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-great-key-migration">The Great Key Migration<a href="#the-great-key-migration" class="hash-link" aria-label="Direct link to The Great Key Migration" title="Direct link to The Great Key Migration">​</a></h3><p>Armed with the results of the benchmarks we had ran, we decided that we would make a gamble. Every table that we had that used a GUID primary key we would alter to contain an auto-incrementing integer primary key, and a GUID UniqueId column with a unique constraint enforced. We would still use the Entity Framework Core GUID value generator to create these unique Ids so to reduce the amount of work SQL would have to do maintaining the unique constraint.</p><p>In the end, it took roughly two weeks of work, and by the end we had modified 600 files according to Git. We ran the benchmark again with the new composite keys and our test script outputted the result:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">612304 total requests completed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">153076 form submissions in 10 minutes across 20 tasks</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This absolutely shocked us. We had more than doubled our throughput, obtaining a total boost of <strong>~127%</strong> by changing our code to use integer primary keys instead of GUIDs. Some may say the time investment or the risk involved isn&#x27;t worth it, but in our minds, the tradeoff we got was more than worth it.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="closing">Closing<a href="#closing" class="hash-link" aria-label="Direct link to Closing" title="Direct link to Closing">​</a></h3><p>I&#x27;d like to end this post with a couple of acknowledgements.</p><p>First, I don&#x27;t believe that using the sequential id generator strategy is bad. The Entity Framework Core team&#x27;s benchmarks show that it does great work in a purely sequential workload. As long as you aren&#x27;t expecting a high degree of parallelism, it seems that they are perfectly fine as a primary key. Even if you do have a parallel workload, its still possible to reorganize your clustered indexes.</p><p>Second, I want to acknowledge that its totally possible that this is all a coincidence, and that the GUIDs weren&#x27;t the cause of the performance issues that we were seeing in SQL Server. It&#x27;s our belief that it&#x27;s the culprit. It&#x27;s also of secondary importance for us to raise awareness that the assumption that we made, that because <code>SequentialGUidValueGenerator</code> uses a strategy optimized for sequential access in SQL server, that GUIDs aren&#x27;t always going to be <em>inserted</em> sequentially.</p><p>Lastly, I encourage anyone who reads this to look into the methods enclosed and run their own benchmarks to draw their own conclusions. If there is a flaw in my methods I&#x27;m happy to make an edit or publish a correction.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="thank-you">Thank You!<a href="#thank-you" class="hash-link" aria-label="Direct link to Thank You!" title="Direct link to Thank You!">​</a></h3><p>Thank you for reading my first blog post, please let me know what worked, and what didn&#x27;t</p><p>-- Conner</p><a name="footnote1"> 1</a> It still perplexes us as to how it didn&#x27;t show up on the smaller machine. It&#x27;s possible (spoiler) that since we had less cores we had a lesser degree of parallelism, so rows were not being inserted out of order as bad.</div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/website/blog/tags/ef-core">ef core</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/website/blog/tags/c">c#</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/website/blog/tags/dotnet">dotnet</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/website/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/website/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/website/assets/js/runtime~main.ed462fe7.js"></script>
<script src="/website/assets/js/main.329b349d.js"></script>
</body>
</html>